apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

replacements:
  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.ARGOCD_SERVER_HOST
    targets:
      - select:
          version: v1
          kind: ConfigMap
          name: argocd-cm
        fieldPaths:
          - data.url
        options:
          delimiter: '//'
          index: 1
      - select:
          version: v1
          group: networking.k8s.io
          kind: Ingress
          name: argocd-server-ingress
        fieldPaths:
          - spec.rules.0.host
          - spec.tls.0.hosts.0

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.ACME_ISSUER_EMAIL
    targets:
      - select:
          group: argoproj.io
          version: v1alpha1
          kind: Application
          name: create-issuer
        fieldPaths:
          - spec.source.helm.parameters.[name=acmeIssuerEmail].value

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.CLUSTER_NAME
    targets:
      - select:
          group: argoproj.io
          version: v1alpha1
          kind: Application
          name: alb-controller
        fieldPaths:
          - spec.source.helm.parameters.[name=clusterName].value
      - select:
          group: argoproj.io
          version: v1alpha1
          kind: Application
          name: external-dns
        fieldPaths:
          - spec.source.helm.parameters.[name=txtOwnerId].value

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.ALB_ROLE_ARN
    targets:
      - select:
          version: v1
          kind: ServiceAccount
          name: aws-load-balancer-controller
        fieldPaths:
          - metadata.annotations.eks\.amazonaws\.com/role-arn

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.EBS_CSI_ROLE_ARN
    targets:
      - select:
          version: v1
          kind: ServiceAccount
          name: ebs-csi-driver
        fieldPaths:
          - metadata.annotations.eks\.amazonaws\.com/role-arn

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.EXTERNAL_DNS_ROLE_ARN
    targets:
      - select:
          version: v1
          kind: ServiceAccount
          name: external-dns-controller
        fieldPaths:
          - metadata.annotations.eks\.amazonaws\.com/role-arn

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.IMAGE_UPDATER_ROLE_ARN
    targets:
      - select:
          version: v1
          kind: ServiceAccount
          name: argocd-image-updater
        fieldPaths:
          - metadata.annotations.eks\.amazonaws\.com/role-arn
        options:
          create: true

  - source:
      version: v1
      kind: ConfigMap
      name: kustomize-environment
      fieldPath: data.VPC_CIDR_BLOCK
    targets:
      - select:
          version: v1
          kind: Deployment
          name: tailscale
        fieldPaths:
          - spec.template.spec.containers.[name=tailscale].env.[name=TS_ROUTES].value
